<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui"><title>Bare metal Java</title><link rel="stylesheet" href="reveal.js/css/reset.css"><link rel="stylesheet" href="reveal.js/css/reveal.css"><link rel="stylesheet" href="reveal.js/css/theme/night.css" id="theme"><!--This CSS is generated by the Asciidoctor reveal.js converter to further integrate AsciiDoc's existing semantic with reveal.js--><style type="text/css">.reveal div.right {
  float: right
}

/* listing block */
.reveal .listingblock.stretch > .content {
  height: 100%
}

.reveal .listingblock.stretch > .content > pre {
  height: 100%
}

.reveal .listingblock.stretch > .content > pre > code {
  height: 100%;
  max-height: 100%
}

/* tables */
table {
  border-collapse: collapse;
  border-spacing: 0
}

table {
  margin-bottom: 1.25em;
  border: solid 1px #dedede
}

table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td {
  padding: .5em .625em .625em;
  font-size: inherit;
  text-align: left
}

table tr th, table tr td {
  padding: .5625em .625em;
  font-size: inherit
}

table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td {
  display: table-cell;
  line-height: 1.6
}

td.tableblock > .content {
  margin-bottom: 1.25em
}

td.tableblock > .content > :last-child {
  margin-bottom: -1.25em
}

table.tableblock, th.tableblock, td.tableblock {
  border: 0 solid #dedede
}

table.grid-all > thead > tr > .tableblock, table.grid-all > tbody > tr > .tableblock {
  border-width: 0 1px 1px 0
}

table.grid-all > tfoot > tr > .tableblock {
  border-width: 1px 1px 0 0
}

table.grid-cols > * > tr > .tableblock {
  border-width: 0 1px 0 0
}

table.grid-rows > thead > tr > .tableblock, table.grid-rows > tbody > tr > .tableblock {
  border-width: 0 0 1px
}

table.grid-rows > tfoot > tr > .tableblock {
  border-width: 1px 0 0
}

table.grid-all > * > tr > .tableblock:last-child, table.grid-cols > * > tr > .tableblock:last-child {
  border-right-width: 0
}

table.grid-all > tbody > tr:last-child > .tableblock, table.grid-all > thead:last-child > tr > .tableblock, table.grid-rows > tbody > tr:last-child > .tableblock, table.grid-rows > thead:last-child > tr > .tableblock {
  border-bottom-width: 0
}

table.frame-all {
  border-width: 1px
}

table.frame-sides {
  border-width: 0 1px
}

table.frame-topbot, table.frame-ends {
  border-width: 1px 0
}

.reveal table th.halign-left, .reveal table td.halign-left {
  text-align: left
}

.reveal table th.halign-right, .reveal table td.halign-right {
  text-align: right
}

.reveal table th.halign-center, .reveal table td.halign-center {
  text-align: center
}

.reveal table th.valign-top, .reveal table td.valign-top {
  vertical-align: top
}

.reveal table th.valign-bottom, .reveal table td.valign-bottom {
  vertical-align: bottom
}

.reveal table th.valign-middle, .reveal table td.valign-middle {
  vertical-align: middle
}

table thead th, table tfoot th {
  font-weight: bold
}

tbody tr th {
  display: table-cell;
  line-height: 1.6
}

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p {
  font-weight: bold
}

thead {
  display: table-header-group
}

.reveal table.grid-none th, .reveal table.grid-none td {
  border-bottom: 0 !important
}

/* kbd macro */
kbd {
  font-family: "Droid Sans Mono", "DejaVu Sans Mono", monospace;
  display: inline-block;
  color: rgba(0, 0, 0, .8);
  font-size: .65em;
  line-height: 1.45;
  background: #f7f7f7;
  border: 1px solid #ccc;
  -webkit-border-radius: 3px;
  border-radius: 3px;
  -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, .2), 0 0 0 .1em white inset;
  box-shadow: 0 1px 0 rgba(0, 0, 0, .2), 0 0 0 .1em #fff inset;
  margin: 0 .15em;
  padding: .2em .5em;
  vertical-align: middle;
  position: relative;
  top: -.1em;
  white-space: nowrap
}

.keyseq kbd:first-child {
  margin-left: 0
}

.keyseq kbd:last-child {
  margin-right: 0
}

/* callouts */
.conum[data-value] {
  display: inline-block;
  color: #fff !important;
  background: rgba(0, 0, 0, .8);
  -webkit-border-radius: 50%;
  border-radius: 50%;
  text-align: center;
  font-size: .75em;
  width: 1.67em;
  height: 1.67em;
  line-height: 1.67em;
  font-family: "Open Sans", "DejaVu Sans", sans-serif;
  font-style: normal;
  font-weight: bold
}

.conum[data-value] * {
  color: #fff !important
}

.conum[data-value] + b {
  display: none
}

.conum[data-value]:after {
  content: attr(data-value)
}

pre .conum[data-value] {
  position: relative;
  top: -.125em
}

b.conum * {
  color: inherit !important
}

.conum:not([data-value]):empty {
  display: none
}

/* Callout list */
.hdlist > table, .colist > table {
  border: 0;
  background: none
}

.hdlist > table > tbody > tr, .colist > table > tbody > tr {
  background: none
}

td.hdlist1, td.hdlist2 {
  vertical-align: top;
  padding: 0 .625em
}

td.hdlist1 {
  font-weight: bold;
  padding-bottom: 1.25em
}

/* Disabled from Asciidoctor CSS because it caused callout list to go under the
 * source listing when .stretch is applied (see #335)
 * .literalblock+.colist,.listingblock+.colist{margin-top:-.5em} */
.colist td:not([class]):first-child {
  padding: .4em .75em 0;
  line-height: 1;
  vertical-align: top
}

.colist td:not([class]):first-child img {
  max-width: none
}

.colist td:not([class]):last-child {
  padding: .25em 0
}

/* Override Asciidoctor CSS that causes issues with reveal.js features */
.reveal .hljs table {
  border: 0
}

/* Callout list rows would have a bottom border with some reveal.js themes (see #335) */
.reveal .colist > table th, .reveal .colist > table td {
  border-bottom: 0
}

/* Fixes line height with Highlight.js source listing when linenums enabled (see #331) */
.reveal .hljs table thead tr th, .reveal .hljs table tfoot tr th, .reveal .hljs table tbody tr td, .reveal .hljs table tr td, .reveal .hljs table tfoot tr td {
  line-height: inherit
}

/* Columns layout */
.columns .slide-content {
  display: flex;
}

.columns.wrap .slide-content {
  flex-wrap: wrap;
}

.columns.is-vcentered .slide-content {
  align-items: center;
}

.columns .slide-content > .column {
  display: block;
  flex-basis: 0;
  flex-grow: 1;
  flex-shrink: 1;
}

.columns .slide-content > .column > * {
  padding: .75rem;
}

/* See #353 */
.columns.wrap .slide-content > .column {
  flex-basis: auto;
}

.columns .slide-content > .column.is-full {
  flex: none;
  width: 100%;
}

.columns .slide-content > .column.is-four-fifths {
  flex: none;
  width: 80%;
}

.columns .slide-content > .column.is-three-quarters {
  flex: none;
  width: 75%;
}

.columns .slide-content > .column.is-two-thirds {
  flex: none;
  width: 66.6666%;
}

.columns .slide-content > .column.is-three-fifths {
  flex: none;
  width: 60%;
}

.columns .slide-content > .column.is-half {
  flex: none;
  width: 50%;
}

.columns .slide-content > .column.is-two-fifths {
  flex: none;
  width: 40%;
}

.columns .slide-content > .column.is-one-third {
  flex: none;
  width: 33.3333%;
}

.columns .slide-content > .column.is-one-quarter {
  flex: none;
  width: 25%;
}

.columns .slide-content > .column.is-one-fifth {
  flex: none;
  width: 20%;
}

.columns .slide-content > .column.has-text-left {
  text-align: left;
}

.columns .slide-content > .column.has-text-justified {
  text-align: justify;
}

.columns .slide-content > .column.has-text-right {
  text-align: right;
}

.columns .slide-content > .column.has-text-left {
  text-align: left;
}

.columns .slide-content > .column.has-text-justified {
  text-align: justify;
}

.columns .slide-content > .column.has-text-right {
  text-align: right;
}

.text-left {
  text-align: left !important
}

.text-right {
  text-align: right !important
}

.text-center {
  text-align: center !important
}

.text-justify {
  text-align: justify !important
}

.footnotes {
  border-top: 1px solid rgba(0, 0, 0, 0.2);
  padding: 0.5em 0 0 0;
  font-size: 0.65em;
  margin-top: 4em;
}
</style><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/v4-shims.min.css"><script type="text/x-mathjax-config">MathJax.Hub.Config({
tex2jax: {
  inlineMath: [["\\(", "\\)"]],
  displayMath: [["\\[", "\\]"]],
  ignoreClass: "nostem|nolatexmath"
},
asciimath2jax: {
  delimiters: [["\\$", "\\$"]],
  ignoreClass: "nostem|noasciimath"
},
TeX: { equationNumbers: { autoNumber: "none" } }
});</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script><!--Printing and PDF exports--><script>var link = document.createElement( 'link' );
link.rel = 'stylesheet';
link.type = 'text/css';
link.href = window.location.search.match( /print-pdf/gi ) ? "reveal.js/css/print/pdf.css" : "reveal.js/css/print/paper.css";
document.getElementsByTagName( 'head' )[0].appendChild( link );</script><link rel="stylesheet" href="css/custom.css"></head><body><div class="reveal"><div class="slides"><section class="title" data-state="title"><h1>Bare metal Java</h1></section><section id="bare_metal_java" class="highlight_section_title" data-background-image="images/pexels-pixabay-327049.jpg"><h2>Bare metal java</h2></section>
<section id="about_me"><h2>about me</h2><div class="slide-content"><div class="paragraph"><p>Jarek Pa≈Çka (@j_palka)</p></div>
<div class="paragraph"><p>Neo4j (a graph database) staff engineer/team lead/benchmarking team</p></div>
<div class="paragraph"><p>over 20 years with JVM ( and people)<br>
speaker, coder, architect</p></div>
<div class="paragraph"><p>founder of SegFault conference<br>
godfather of Programistyczna Grupa Rozwoju</p></div></div></section>
<section><section id="disclaimer"><h2>DISCLAIMER</h2><div class="slide-content"><div class="paragraph"><p>this presentation may contain strong language,<br>
my own opinions, references to sex, drugs, religion, alcohol and politics</p></div><div class="paragraph"><p>if this does make you feel offended<br>
that&#8217;s good it means you have something you care about in your life</p></div></div></section><section id="agenda"><h2>agenda</h2><div class="slide-content"><div class="paragraph"><p><a href="#the_raise_and_fall_on_managed_runtime">a sip of history</a><br>
<a href="#malloc_baby">malloc, baby!</a><br>
<a href="#hello_c">hello, C!</a></p></div></div></section></section>
<section><section id="the_raise_and_fall_on_managed_runtime"><h2>the raise and fall on managed runtime</h2><div class="slide-content"><div class="paragraph"><p>yet another taxonomy of programming languages</p></div><div class="ulist"><ul><li><p>compiled (C/C++)</p></li><li><p>compiled with managed runtime (Go, Pony)</p></li><li><p>interpreted with managed runtime (LISP,Smalltalk,Java,C#,JavaScript,Erlang,Python, PHP, Perl) (aka virtual machines)</p></li></ul></div></div></section><section id="managed_runtime"><h2>managed runtime</h2><div class="slide-content"><div class="paragraph"><p>all the hard things</p></div>
<div class="ulist"><ul><li><p>memory management (garbage collectors)</p></li><li><p>threads management</p></li><li><p>code management (runtime linking)</p></li><li><p>calling native code (because we are interpreted)</p></li><li><p>(operating system abstraction)*</p></li></ul></div></div></section><section id="why"><h2>why?</h2><div class="slide-content"><div class="paragraph"><p>to give up control for safety<br>
(it is not the only reason)</p></div></div></section><section><div class="slide-content"><div class="ulist"><ul><li><p>memory safety</p></li><li><p>operation safety</p></li><li><p>execution safety</p></li></ul></div></div></section><section><div class="slide-content"><div class="paragraph"><p>when you give up control,<br>
you loose a lot of opportunities to optimize your code<br>
(notice I didn&#8217;t say you loose performance)</p></div></div></section></section>
<section><section id="java_as_a_systems_language"><h2>Java as a system&#8217;s language?</h2><div class="slide-content"><div class="paragraph"><p>stupid idea!<br>
(especially when management of resources is critical)</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>Apache Kafka<br>
Neo4j<br>
Elastic<br>
Hazelcast<br>
Cassandra<br>
Apache BigData Ecosystem</p></div></div></section><section id="are_these_people_stupid_or"><h2>are these people stupid or?</h2></section><section data-background-image="https://media.giphy.com/media/XoWvzO2gYjqpUrjCRl/giphy.gif" data-background-size="contain"></section><section><div class="slide-content"><div class="paragraph"><p><strong>NO</strong></p></div>
<div class="paragraph"><p>safety is more important than speed</p></div>
<div class="paragraph"><p>you don&#8217;t want your databases to randomly crash</p></div></div></section><section id="but_all_we_need_is"><h2>but all we need is</h2><div class="slide-content"><div class="paragraph"><p>need for speed :)</p></div></div></section><section id="sun_misc_unsafe"><h2>sun.misc.Unsafe</h2><div class="slide-content"><div class="paragraph"><p>internal API abused beyond creators imagination</p></div>
<div class="ulist"><ul><li><p>memory allocation</p></li><li><p>object layout</p></li><li><p>low level concurrency controls</p></li><li><p>serialization</p></li></ul></div></div></section><section id="welcome_bare_metal_java"><h2>welcome, bare metal Java</h2><div class="slide-content"><div class="ulist"><ul><li><p>foreign memory</p></li><li><p>foreign linker</p></li><li><p>vectorization</p></li><li><p>frozen arrays</p></li><li><p>primitive objects (part of Valhalla)</p></li><li><p>low-level concurrency controls (VarHandles)</p></li></ul></div></div></section></section>
<section><section id="malloc_baby"><h2>malloc, baby</h2></section><section id="directbytebuffer"><h2>DirectByteBuffer</h2><div class="slide-content"><div class="paragraph"><p>freeing unused memory when no longer referenced<br>
inefficient under pressure</p></div></div></section><section id="unsafe_allocatememory"><h2>Unsafe.allocateMemory</h2><div class="slide-content"><div class="paragraph"><p>breaks memory safety guarantees,<br>
not official API,</p></div></div></section><section id="jni" data-background-image="https://media.giphy.com/media/yvBAuESRTsETqNFlEl/giphy.gif"><h2>JNI</h2></section><section id="it_takes_five"><h2>it takes five</h2><div class="slide-content"><div class="ulist"><ul><li><p>first proposed by JEP 370 and targeted to Java 14</p></li><li><p>and later re-incubated by JEP 383 which was targeted to Java 15</p></li><li><p>third proposal <a href="https://openjdk.java.net/jeps/393">JEP 393: Foreign-Memory Access API (Third Incubator)</a> released with Java 16</p></li><li><p>fourth proposal <a href="https://openjdk.java.net/jeps/412">JEP 412: Foreign Function &amp; Memory API (Incubator)</a> (merge of two JEPs, but more about it later)</p></li><li><p>fifth proposal <a href="https://openjdk.java.net/jeps/419">JEP 419: Foreign Function &amp; Memory API (Second Incubator)</a>, simpler API, support for more carrier types</p></li></ul></div></div></section><section id="goals"><h2>goals</h2><div class="slide-content"><div class="quoteblock"><blockquote>Generality: A single API should be able to operate on various kinds of foreign memory (e.g., native memory, persistent memory, managed heap memory, etc.).</blockquote><div class="attribution"><cite>JEP 412</cite></div></div></div></section><section id="goals_2"><h2>goals</h2><div class="slide-content"><div class="quoteblock"><blockquote>Safety: It should not be possible for the API to undermine the safety of the JVM, regardless of the kind of memory being operated upon.</blockquote><div class="attribution"><cite>JEP 412</cite></div></div></div></section><section id="goals_3"><h2>goals</h2><div class="slide-content"><div class="quoteblock"><blockquote>Control: Clients should have options as to how memory segments are to be deallocated: either explicitly (via a method call) or implicitly (when the segment is no longer in use).</blockquote><div class="attribution"><cite>JEP 412</cite></div></div></div></section><section id="goals_4"><h2>goals</h2><div class="slide-content"><div class="quoteblock"><blockquote>Usability: For programs that need to access foreign memory, the API should be a compelling alternative to legacy Java APIs such as sun.misc.Unsafe.</blockquote><div class="attribution"><cite>JEP 412</cite></div></div></div></section><section id="motivation"><h2>motivation</h2><div class="slide-content"><div class="quoteblock"><blockquote>Many Java programs access foreign memory, such as Ignite, mapDB, memcached, Lucene, and Netty&#8217;s ByteBuf API.</blockquote><div class="attribution"><cite>JEP 412</cite></div></div></div></section><section><div class="slide-content"><div class="paragraph"><p>By doing so they can:</p></div>
<div class="ulist"><ul><li><p>Avoid the cost and unpredictability associated with garbage collection (especially when maintaining large caches);</p></li><li><p>Share memory across multiple processes; and</p></li><li><p>Serialize and deserialize memory content by mapping files into memory (via, e.g., mmap).</p></li></ul></div></div></section><section id="the_foreign_memory_access_api"><h2>The Foreign-Memory Access API</h2><div class="slide-content"><div class="ulist"><ul><li><p>MemorySegment &amp; ResourceScope</p></li><li><p>MemoryAddress</p></li><li><p>MemoryLayout</p></li></ul></div></div></section><section id="memorysegment"><h2>MemorySegment</h2><div class="slide-content"><div class="paragraph"><p>models a contiguous memory region with given spatial and temporal bounds,<br>
any access outside spatial or temporal bounds will end upt with exception</p></div>
<div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-noescape="true" data-lang="java">import jdk.incubator.foreign.*;

try (var resourceScope = ResourceScope.newConfinedScope()) {
    var memorySegment = MemorySegment.allocateNative(1024, resourceScope);
}</code></pre></div></div></div></section><section><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-noescape="true" data-lang="java">import jdk.incubator.foreign.*;

var resourceScope = ResourceScope.newImplicitScope();
var memorySegment = MemorySegment.allocateNative(1024, resourceScope);
resourceScope.close(); // hi, manual memory management</code></pre></div></div></div></section><section><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-noescape="true" data-lang="java">import jdk.incubator.foreign.*;
import java.lang.ref.Cleaner;

var cleaner = Cleaner.create(); //uses PhantomReferences and ReferenceQueue
var resourceScope = ResourceScope.newImplicitScope(cleaner);
var memorySegment = MemorySegment.allocateNative(1024)); // GC will cleanup this segment</code></pre></div></div></div></section><section><div class="slide-content"><div class="paragraph"><p>memory segment can be:</p></div>
<div class="ulist"><ul><li><p>on-heap</p></li><li><p>off-heap</p></li><li><p>memory mapped file</p></li><li><p>NVRAM (<a href="https://openjdk.java.net/jeps/352">JEP 352: Non-Volatile Mapped Byte Buffers</a>)</p></li></ul></div></div></section><section id="thread_confinement"><h2>thread confinement</h2><div class="slide-content"><div class="paragraph"><p>if you use <em>confined or implicit scope</em>,<br>
memory segments are confined to thread it created,<br>
any access from other threads is forbidden,</p></div>
<div class="paragraph"><p>you can use <em>shared scope</em> to make segment shareable between threads</p></div></div></section><section id="dereferencing_memory"><h2>dereferencing memory</h2><div class="slide-content"><div class="ulist"><ul><li><p><code>MemoryHandles</code> is based on same concepts as <code>VarHandle</code></p></li><li><p>to obtain a memory access var handle, clients must start from <code>MemoryLayout.varHandle(Class&lt;?&gt; carrier, PathElement&#8230;&#8203; elements)</code> or 'MemoryHandles.varHandle(Class&lt;?&gt; carrier, ByteOrder byteOrder)' or <code>MemoryHandles.varHandle(Class&lt;?&gt; carrier, long alignmentBytes, ByteOrder byteOrder)</code></p></li><li><p>This determines the variable type (all primitive types but void and boolean are supported), as well as the alignment constraint, and the byte order associated to a memory access var handle.</p></li><li><p><code>carrier</code> type is <em>primitive</em> type which will carry value of memory segment</p></li><li><p>The resulting memory access var handle can then be combined in various ways to emulate different addressing modes.</p></li><li><p>The var handles created by this class feature a mandatory coordinate type (of type MemorySegment), and one long coordinate type, which represents the offset, in bytes, relative to the segment, at which dereference should occur.</p></li></ul></div></div></section><section id="sounds_cryptic"><h2>sounds cryptic?</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-noescape="true" data-lang="java">import jdk.incubator.foreign.*;
import java.nio.ByteOrder;
import java.lang.invoke.VarHandle;

var varHandleGet = MemoryHandles.varHandle(int.class, ByteOrder.nativeOrder());
out.println("Var handle for GET access mode: " + varHandleGet.toMethodHandle(VarHandle.AccessMode.GET).type());

var varHandleSet = MemoryHandles.varHandle(int.class, ByteOrder.nativeOrder());
out.println("Var handle for SET access mode: " + varHandleSet.toMethodHandle(VarHandle.AccessMode.SET).type());

try (var resourceScope = ResourceScope.newConfinedScope()) {
    var memorySegment = MemorySegment.allocateNative(1024, resourceScope);
    var offset = 512;
    var value = 2048;
    varHandleGet.set(memorySegment, offset, value);

    out.println("value = " + varHandleGet.get(memorySegment, offset));

    var varHandle = MemoryHandles.insertCoordinates(varHandleGet, 1, offset);
    out.println("modified var handle for GET access mode" + varHandle.toMethodHandle(VarHandle.AccessMode.GET).type());
    out.println("value = " + varHandle.get(memorySegment));
}</code></pre></div></div></div></section><section><div class="slide-content"><div class="quoteblock"><blockquote>To make the FFM API more approachable, the MemoryAccess class provides static accessors to dereference memory segments without the need to construct memory-access var handles.</blockquote><div class="attribution"><cite>JEP-412</cite></div></div></div></section><section id="memorylayout"><h2>MemoryLayout</h2><div class="slide-content"><div class="paragraph"><p>a programmatic description of a memory segment&#8217;s contents</p></div>
<div class="ulist"><ul><li><p>sequences</p></li><li><p>structs</p></li><li><p>unions</p></li></ul></div></div></section><section id="c_struct"><h2>C struct</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-C hljs" data-noescape="true" data-lang="C">struct {
    int value;
    struct {
        int year;
        int month;
        int day;
    } date;
}</code></pre></div></div></div></section><section id="memory_layout"><h2>memory layout</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-noescape="true" data-lang="java">import jdk.incubator.foreign.*;

 var struct = MemoryLayout.structLayout(
                CLinker.C_INT.withName("age"),
                CLinker.C_INT.withName("kids"),
                CLinker.C_POINTER.withName("birthDate"),
                MemoryLayout.structLayout(CLinker.C_POINTER.withName("street"))
                        .withName("address"));
 var streetVarHandle = struct.varHandle(long.class, groupElement("address"), groupElement("street"));
 out.println("set address.street field in struct method handle type: " + streetVarHandle.toMethodHandle(VarHandle.AccessMode.SET).type());
 out.println("get address.street field in struct method handle type: " + streetVarHandle.toMethodHandle(VarHandle.AccessMode.GET).type());

 try (var resourceScope = ResourceScope.newConfinedScope()) {
     var memorySegment = MemorySegment.allocateNative(struct, resourceScope);
     var string = CLinker.toCString("Wielkiego Stacha 16b, Psie Pole", resourceScope);
     var asAddressVarHandle = MemoryHandles.asAddressVarHandle(streetVarHandle);

     asAddressVarHandle.set(memorySegment, string.address());
 }</code></pre></div></div></div></section><section id="alignment_padding_and_access_modes"><h2>alignment, padding and access modes</h2><div class="slide-content"><div class="ulist"><ul><li><p>data structure alignment, unaligned access will throw exception,</p></li><li><p>memory layout supports padding,</p></li><li><p>var handles on memory segments can use <code>MemoryAccess</code> modes (atomic, volatile, acquire-get), please read documentation, there are rules around padding and sizes</p></li></ul></div></div></section><section id="unsafe_memory_segments"><h2>unsafe memory segments</h2><div class="slide-content"><div class="quoteblock"><blockquote>Dereference operations are only possible on memory segments. Since a memory segment has spatial and temporal bounds, the Java runtime can always ensure that memory associated with a given segment is dereferenced safely. However, there are situations where clients might only have a MemoryAddress instance, as is often the case when interacting with native code. Since the Java runtime has no way to know the spatial and temporal bounds associated with a memory address, directly dereferencing memory addresses is forbidden by the FFM API.</blockquote><div class="attribution"><cite>JEP 412</cite></div></div></div></section><section><div class="slide-content"><div class="paragraph"><p><strong>Since the Java runtime has no way to know the spatial and temporal bounds associated with a memory address, directly dereferencing memory addresses is forbidden by the FFM API</strong></p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>what if dont' have <code>MemorySegment</code> but just a <code>MemoryAddress</code>?<br>
(like in examples in section to follow)</p></div></div></section><section><div class="slide-content"><div class="ulist"><ul><li><p>If the address is known to fall within a memory segment, the client can perform a rebase operation via MemoryAddress::segmentOffset. The rebasing operation re-interprets the address&#8217;s offset relative to the segment&#8217;s base address to yield a new offset which can be applied to the existing segment ‚Äî which can then be safely dereferenced</p></li><li><p>Alternatively, if no such segment exists then the client can create one unsafely, using the MemoryAddress::asSegment factory. This factory effectively attaches fresh spatial and temporal bounds to an otherwise raw memory address, so as to allow dereference operations. The memory segment returned by this factory is unsafe: A raw memory address might be associated with a memory region that is 10 bytes long, but the client might accidentally overestimate the size of the region and create an unsafe memory segment that is 100 bytes long. This might result, later, in attempts to dereference memory outside the bounds of the memory region associated with the unsafe segment, which might cause a JVM crash or, worse, result in silent memory corruption. For this reason, creating unsafe segments is regarded as a restricted operation, and is disabled by default</p></li></ul></div></div></section><section id="safety"><h2>safety</h2><div class="slide-content"><div class="quoteblock"><blockquote>To enable access to unsafe methods for code in some module M, specify java --enable-native-access=M on the command line.</blockquote><div class="attribution"><cite>JEP-412</cite></div></div></div></section><section id="things_we_didnt_discuss"><h2>things we didn&#8217;t discuss</h2><div class="slide-content"><div class="ulist"><ul><li><p><code>SegmentAllocator</code> and custom allocators</p></li><li><p>memory access mode (whole new separate presentation)</p></li></ul></div></div></section><section id="hello_c"><h2>hello C</h2><div class="slide-content"><div class="ulist"><ul><li><p>JNI, old, slow, hard to implement,no major improvements since release,</p></li><li><p>and collection of JNI wrappers,</p><div class="ulist"><ul><li><p><a href="https://github.com/java-native-access/jna">JNA</a></p></li><li><p><a href="https://github.com/jnr/jnr-ffi">jnr-ffi</a></p></li><li><p><a href="https://github.com/bytedeco/javacpp">JavaCPP</a></p></li><li><p><a href="https://github.com/jmarranz/jnieasy">JNIEasy</a></p></li></ul></div></li></ul></div></div></section><section id="eat_your_own_dog_food"><h2>eat your own dog food</h2><div class="slide-content"><div class="paragraph"><p>JNI is used in many places in JDK (and JVM),<br>
these things are inherently slow and bloated<br>
my favorite part java.io and java.net</p></div></div></section><section id="state_of_affairs"><h2>state of affairs</h2><div class="slide-content"><div class="paragraph"><p>The initial scope of this effort aims at providing high quality, fully optimized interoperability with C libraries, on x64 and AArch64 platforms.</p></div>
<div class="paragraph"><p>The Foreign Linker API and implementation should be flexible enough to, over time, accommodate support for other platforms (e.g., 32-bit x86) and foreign functions written in languages other than C (e.g. C++, Fortran).</p></div></div></section><section id="say_hi_to_clinker"><h2>say hi to <code>CLinker</code></h2><div class="slide-content"><div class="ulist"><ul><li><p>downcalls (e.g. calls from Java to native code), the downcallHandle method can be used to model native functions as plain MethodHandle objects.</p></li><li><p>upcalls (e.g. calls from native back to Java code), the upcallStub method can be used to convert an existing MethodHandle (which might point to some Java method) into a MemorySegment, which can then be passed to a native function as a function pointer.</p></li></ul></div></div></section><section id="center_of_the_universe"><h2>center of the universe</h2><div class="slide-content"><div class="ulist"><ul><li><p>CLinker</p></li><li><p>SymbolLookup</p></li><li><p>FunctionDescriptor</p></li></ul></div></div></section><section id="downcalls"><h2>downcalls</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-noescape="true" data-lang="java">var libraryLookup = CLinker.systemLookup();

var getpidSymbol = libraryLookup.lookup("getpid")
                .orElseThrow(() -&gt; new RuntimeException("getpid symbol not found"));

var functionDescriptor = FunctionDescriptor.of(CLinker.C_INT);
var methodType = MethodType.methodType(int.class);
var methodHandle = CLinker.getInstance().downcallHandle(getpidSymbol,
                                                        methodType,
                                                        functionDescriptor);
System.out.println(methodHandle.invoke());</code></pre></div></div></div></section><section id="upcalls"><h2>upcalls</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-noescape="true" data-lang="java">import jdk.incubator.foreign.CLinker;
import jdk.incubator.foreign.FunctionDescriptor;
import jdk.incubator.foreign.LibraryLookup;
import jdk.incubator.foreign.MemoryAddress;
import java.lang.invoke.MethodHandles;
import java.lang.invoke.MethodType;
import static java.lang.System.out;

        var symbolLookup = CLinker.systemLookup();

        var cLinker = CLinker.getInstance();

        out.println("creating signal handler stub");
        // QUESTION: why the hell global scope?
        var resourceScope = ResourceScope.globalScope();
        var signalHandler = MethodHandles.lookup()
                .findStatic(SIGTERM.class, "onSignal",
                        MethodType.methodType(void.class, int.class));
        var signalHandlerStub = cLinker.upcallStub(signalHandler,
                FunctionDescriptor.ofVoid(CLinker.C_INT), resourceScope);

        out.println("installing signal handler " + signalHandlerStub);
        var signal = symbolLookup.lookup("signal")
                .orElseThrow(() -&gt; new RuntimeException("signal symbol not found"));
        var signalHandle = cLinker.downcallHandle(signal,
                MethodType.methodType(void.class, int.class, MemoryAddress.class),
                FunctionDescriptor.ofVoid(CLinker.C_INT, CLinker.C_POINTER));
        out.println(signalHandle.type());
        signalHandle.invoke(15, signalHandlerStub.address());</code></pre></div></div></div></section><section data-background-image="https://media.giphy.com/media/plcoWBSrPvOP6/giphy.gif"></section><section id="too_much_magic"><h2>too much magic</h2><div class="slide-content"><div class="paragraph"><p>as you can imagine, it means handwriting all <code>FunctionDescriptor</code> and structs and unions
from C header files, to be able to work any advanced C library</p></div></div></section><section id="a_real_gem"><h2>a real gem</h2><div class="slide-content"><div class="paragraph"><p>panama early access builds contain <code>jextract</code> command line, which generates
classes (and source files), from any C header file,</p></div>
<div class="paragraph"><p>with some limitations</p></div>
<div class="paragraph"><p><a href="https://jdk.java.net/panama/">Project Panama Early-Access Builds</a></p></div></div></section><section id="jextract"><h2>jextract</h2><div class="slide-content"><div class="paragraph"><p>it generates Java code from C header files</p></div>
<div class="literalblock"><div class="content"><pre>jextract -d ${build.directory}/generated-sources -t pl.symentis.foreign.posix --source /usr/include/mqueue.h</pre></div></div></div></section></section>
<section><section id="vectorization"><h2>vectorization</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-noescape="true" data-lang="java">x1=y1+z1;
x2=y2+z2;
x3=y3+z3;
x4=y4+z4;</code></pre></div></div></div></section><section><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-noescape="true" data-lang="java">[y1,y2,y3,y4]+[z1,z2,z3,z4]</code></pre></div></div></div></section><section id="nothing_new"><h2>nothing new</h2><div class="slide-content"><div class="paragraph"><p>SIMD (Single Instruction Multiple Data)</p></div>
<div class="paragraph"><p>x86 SSE and AVX extensions<br>
add new instructions and wide registers</p></div></div></section><section><div class="slide-content"><div class="paragraph"><p>JVM has support for it for a long time<br></p></div>
<div class="paragraph"><p>but you have almost no control over it</p></div></div></section><section id="intrinsics"><h2>intrinsics</h2><div class="slide-content"><div class="paragraph"><p><code>Arrays.fill()</code><br>
<code>System.arrayCopy()</code></p></div>
<div class="paragraph"><p>these methods have their optimized stubs (not a JNI call)</p></div></div></section><section id="c2_optimizations"><h2>C2 optimizations</h2><div class="slide-content"><div class="paragraph"><p>JIT tries hard to recognize a patterns in you code and transform it using SIMD</p></div>
<div class="paragraph"><p>hint: run below code with and without -XX:-UseSuperWord</p></div>
<div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-noescape="true" data-lang="java">float[] a = ...

for (int i = 0; i &lt; a.length; i++) {
    a[i] = a[i] * a[i];
}</code></pre></div></div></div></section><section><div class="slide-content"><div class="paragraph"><p><a href="http://groups.csail.mit.edu/commit/papers/00/SLP-PLDI-2000.pdf">Exploiting Superword Level Parallelism with Multimedia InstructionSets</a><br>
<a href="http://psy-lob-saw.blogspot.com/2015/04/on-arraysfill-intrinsics-superword-and.html">On Arrays.fill, Intrinsics, SuperWord and SIMD instructions</a><br>
<a href="https://richardstartin.github.io/tags/vector">Richard Startin&#8217;s Blog, Vectorisation</a></p></div></div></section><section><div class="slide-content"><div class="quoteblock"><blockquote>Because AVX can reduce the processor frequency, it‚Äôs not always profitable to vectorise, so compilers employ cost models to decide when they should do so.
Such cost models require platform specific calibration, and sometimes C2 can get it wrong</blockquote><div class="attribution"><cite>Vectorised Algorithms in Java</cite><br>&#8212; Richard Starin</div></div></div></section><section id="vector_api"><h2>vector api</h2><div class="slide-content"><div class="paragraph"><p><a href="https://openjdk.java.net/jeps/414">JEP 414: Vector API (Second Incubator)</a></p></div></div></section><section id="goals_5"><h2>goals</h2><div class="slide-content"><div class="paragraph"><p>Clear and concise API ‚Äî The API should be capable of clearly and concisely expressing a wide range of vector computations consisting of sequences of vector operations composed within loops and possibly with control flow.
It should be possible to express a computation that is generic with respect to vector size, or the number of lanes per vector, thus enabling such computations to be portable across hardware supporting different vector sizes</p></div></div></section><section id="goals_6"><h2>goals</h2><div class="slide-content"><div class="paragraph"><p>Platform agnostic ‚Äî The API should be CPU architecture agnostic, enabling implementations on multiple architectures supporting vector instructions.
As is usual in Java APIs, where platform optimization and portability conflict then the bias will be toward making the API portable, even if that results in some platform-specific idioms not being expressible in portable code.</p></div></div></section><section id="goals_7"><h2>goals</h2><div class="slide-content"><div class="paragraph"><p>Reliable runtime compilation and performance on x64 and AArch64 architectures ‚Äî On capable x64 architectures the Java runtime, specifically the HotSpot C2 compiler, should compile vector operations to corresponding efficient and performant vector instructions, such as those supported by Streaming SIMD Extensions (SSE) and Advanced Vector Extensions (AVX).
Developers should have confidence that the vector operations they express will reliably map closely to relevant vector instructions.
On capable ARM AArch64 architectures C2 will, similarly, compile vector operations to the vector instructions supported by NEON.</p></div></div></section><section id="goals_8"><h2>goals</h2><div class="slide-content"><div class="paragraph"><p>Graceful degradation ‚Äî Sometimes a vector computation cannot be fully expressed at runtime as a sequence of vector instructions, perhaps because the architecture does not support some of the required instructions.
In such cases the Vector API implementation should degrade gracefully and still function.
This may involve issuing warnings if a vector computation cannot be efficiently compiled to vector instructions.
On platforms without vectors, graceful degradation will yield code competitive with manually-unrolled loops, where the unroll factor is the number of lanes in the selected vector.</p></div></div></section><section id="core_concepts"><h2>core concepts</h2><div class="slide-content"><div class="imageblock"><img src="images/diag-6e11347bb11f3d41e269e71211b6f52c.png" alt="Diagram"></div></div></section><section id="lane_wise_operation"><h2>lane wise operation</h2><div class="slide-content"><div class="imageblock"><img src="images/diag-4f9632a0f0ee02fdc0d3b0ea95d0aa07.png" alt="Diagram"></div></div></section><section><div class="slide-content"><div class="quoteblock"><blockquote>A lane-wise operation applies a scalar operator, such as addition, to each lane of one or more vectors in parallel.
A lane-wise operation usually, but not always, produces a vector of the same length and shape.
Lane-wise operations are further classified as unary, binary, ternary, test, or conversion operations.</blockquote><div class="attribution"><cite>JEP 414</cite></div></div></div></section><section id="cross_lane_operation"><h2>cross lane operation</h2><div class="slide-content"><div class="imageblock"><img src="images/diag-5e0dd6fc436b3e4e18ce1fa97d56a842.png" alt="Diagram"></div></div></section><section><div class="slide-content"><div class="quoteblock"><blockquote>A cross-lane operation applies an operation across an entire vector.
A cross-lane operation produces either a scalar or a vector of possibly a different shape.
Cross-lane operations are further classified as permutation or reduction operations.</blockquote><div class="attribution"><cite>JEP 414</cite></div></div></div></section><section id="vector_shapes"><h2>vector shapes</h2><div class="slide-content"><div class="quoteblock"><blockquote>The shape of a vector governs how an instance of Vector&lt;E&gt; is mapped to a hardware vector register when vector computations are compiled by the HotSpot C2 compiler.
The length of a vector, i.e., the number of lanes or elements, is the vector size divided by the element size.</blockquote><div class="attribution"><cite>JEP 414</cite></div></div></div></section><section id="at_runtime"><h2>at runtime</h2><div class="slide-content"><div class="quoteblock"><blockquote>The Vector API has two implementations.
The first implements operations in Java, thus it is functional but not optimal.
The second defines intrinsic vector operations for the HotSpot C2 run-time compiler so that it can compile vector computations to appropriate hardware registers and vector instructions when available.</blockquote><div class="attribution"><cite>JEP 414</cite></div></div></div></section><section><div class="slide-content"><div class="quoteblock"><blockquote>To avoid an explosion of C2 intrinsics we define generalized intrinsics corresponding to the various kinds of operations such as unary, binary, conversion, and so on, which take a parameter describing the specific operation to be performed.
Approximately twenty new intrinsics support the intrinsification of the entire API.</blockquote><div class="attribution"><cite>JEP 414</cite></div></div></div></section><section id="vector_operations"><h2>vector operations</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-noescape="true" data-lang="java">static final VectorSpecies&lt;Float&gt; SPECIES = FloatVector.SPECIES_PREFERRED;

void vectorComputation(float[] a, float[] b, float[] c) {
    int i = 0;
    int upperBound = SPECIES.loopBound(a.length);
    for (; i &lt; upperBound; i += SPECIES.length()) {
        // FloatVector va, vb, vc;
        var va = FloatVector.fromArray(SPECIES, a, i);
        var vb = FloatVector.fromArray(SPECIES, b, i);
        var vc = va.mul(va)
                   .add(vb.mul(vb))
                   .neg();
        vc.intoArray(c, i);
    }

    // no SIMD
    for (; i &lt; a.length; i++) {
        c[i] = (a[i] * a[i] + b[i] * b[i]) * -1.0f;
    }
}</code></pre></div></div></div></section><section id="warning"><h2>WARNING!!!</h2><div class="slide-content"><div class="quoteblock"><blockquote>This implementation achieves optimal performance on large arrays.</blockquote><div class="attribution"><cite>JEP 414</cite></div></div></div></section><section id="you_may_ask_yourself_how_large"><h2>you may ask yourself how large?</h2></section><section id="demo" class="highlight_section_title" data-background-image="images/pexels-web-donut-19101.jpg"><h2>demo</h2></section><section><div class="slide-content"><div class="paragraph"><p>if it doesn&#8217;t make sens, your not alone</p></div></div></section><section><div class="slide-content"><div class="ulist"><ul><li><p>no, it is not because there are allocations (scalar replacement, not sure)</p></li><li><p>this code is heavily inlined with <code>@ForceInline</code></p></li><li><p>looks like generated intrinsics are not optimal (yet)</p></li></ul></div></div></section><section id="why_bother"><h2>why bother?</h2><div class="slide-content"><div class="paragraph"><p>C2 will not always recognize your code as <em>vectorizable</em>,<br>
then use Vector API<br>
(first measure, profile, adapt)</p></div></div></section><section><div class="slide-content"><div class="quoteblock"><blockquote>it seems that auto-vectorization of scalar code is not a reliable tactic for optimizing ad-hoc user-written loops unless the user pays unusually careful attention to unwritten contracts about exactly which loops a compiler is prepared to auto-vectorize.
It is too easy to write a loop that fails to auto-vectorize, for a reason that no human reader can detect.
Years of work on auto-vectorization, even in HotSpot, have left us with lots of optimization machinery that works only on special occasions.
We want to enjoy the use of this machinery more often!</blockquote><div class="attribution"><cite>JEP 414</cite></div></div></div></section><section id="whats_next"><h2>what&#8217;s next?</h2><div class="slide-content"><div class="ulist"><ul><li><p>frozen arrays</p></li><li><p>primitive objects (part of Valhalla)</p></li><li><p>low-level concurrency controls (VarHandles)</p></li></ul></div></div></section></section>
<section id="thank_you"><h2>thank you</h2></section></div></div><script src="reveal.js/js/reveal.js"></script><script>Array.prototype.slice.call(document.querySelectorAll('.slides section')).forEach(function(slide) {
  if (slide.getAttribute('data-background-color')) return;
  // user needs to explicitly say he wants CSS color to override otherwise we might break custom css or theme (#226)
  if (!(slide.classList.contains('canvas') || slide.classList.contains('background'))) return;
  var bgColor = getComputedStyle(slide).backgroundColor;
  if (bgColor !== 'rgba(0, 0, 0, 0)' && bgColor !== 'transparent') {
    slide.setAttribute('data-background-color', bgColor);
    slide.style.backgroundColor = 'transparent';
  }
});

// More info about config & dependencies:
// - https://github.com/hakimel/reveal.js#configuration
// - https://github.com/hakimel/reveal.js#dependencies
Reveal.initialize({
  // Display presentation control arrows
  controls: false,
  // Help the user learn the controls by providing hints, for example by
  // bouncing the down arrow when they first encounter a vertical slide
  controlsTutorial: true,
  // Determines where controls appear, "edges" or "bottom-right"
  controlsLayout: 'bottom-right',
  // Visibility rule for backwards navigation arrows; "faded", "hidden"
  // or "visible"
  controlsBackArrows: 'faded',
  // Display a presentation progress bar
  progress: true,
  // Display the page number of the current slide
  slideNumber: false,
  // Control which views the slide number displays on
  showSlideNumber: 'all',
  // Add the current slide number to the URL hash so that reloading the
  // page/copying the URL will return you to the same slide
  hash: false,
  // Push each slide change to the browser history. Implies `hash: true`
  history: true,
  // Enable keyboard shortcuts for navigation
  keyboard: true,
  // Enable the slide overview mode
  overview: true,
  // Disables the default reveal.js slide layout so that you can use custom CSS layout
  disableLayout: false,
  // Vertical centering of slides
  center: true,
  // Enables touch navigation on devices with touch input
  touch: true,
  // Loop the presentation
  loop: false,
  // Change the presentation direction to be RTL
  rtl: false,
  // See https://github.com/hakimel/reveal.js/#navigation-mode
  navigationMode: 'default',
  // Randomizes the order of slides each time the presentation loads
  shuffle: false,
  // Turns fragments on and off globally
  fragments: true,
  // Flags whether to include the current fragment in the URL,
  // so that reloading brings you to the same fragment position
  fragmentInURL: false,
  // Flags if the presentation is running in an embedded mode,
  // i.e. contained within a limited portion of the screen
  embedded: false,
  // Flags if we should show a help overlay when the questionmark
  // key is pressed
  help: true,
  // Flags if speaker notes should be visible to all viewers
  showNotes: false,
  // Global override for autolaying embedded media (video/audio/iframe)
  // - null: Media will only autoplay if data-autoplay is present
  // - true: All media will autoplay, regardless of individual setting
  // - false: No media will autoplay, regardless of individual setting
  autoPlayMedia: null,
  // Global override for preloading lazy-loaded iframes
  // - null: Iframes with data-src AND data-preload will be loaded when within
  //   the viewDistance, iframes with only data-src will be loaded when visible
  // - true: All iframes with data-src will be loaded when within the viewDistance
  // - false: All iframes with data-src will be loaded only when visible
  preloadIframes: null,
  // Number of milliseconds between automatically proceeding to the
  // next slide, disabled when set to 0, this value can be overwritten
  // by using a data-autoslide attribute on your slides
  autoSlide: 0,
  // Stop auto-sliding after user input
  autoSlideStoppable: true,
  // Use this method for navigation when auto-sliding
  autoSlideMethod: Reveal.navigateNext,
  // Specify the average time in seconds that you think you will spend
  // presenting each slide. This is used to show a pacing timer in the
  // speaker view
  defaultTiming: 120,
  // Specify the total time in seconds that is available to
  // present.  If this is set to a nonzero value, the pacing
  // timer will work out the time available for each slide,
  // instead of using the defaultTiming value
  totalTime: 0,
  // Specify the minimum amount of time you want to allot to
  // each slide, if using the totalTime calculation method.  If
  // the automated time allocation causes slide pacing to fall
  // below this threshold, then you will see an alert in the
  // speaker notes window
  minimumTimePerSlide: 0,
  // Enable slide navigation via mouse wheel
  mouseWheel: false,
  // Hide cursor if inactive
  hideInactiveCursor: true,
  // Time before the cursor is hidden (in ms)
  hideCursorTime: 5000,
  // Hides the address bar on mobile devices
  hideAddressBar: true,
  // Opens links in an iframe preview overlay
  // Add `data-preview-link` and `data-preview-link="false"` to customise each link
  // individually
  previewLinks: false,
  // Transition style (e.g., none, fade, slide, convex, concave, zoom)
  transition: 'slide',
  // Transition speed (e.g., default, fast, slow)
  transitionSpeed: 'default',
  // Transition style for full page slide backgrounds (e.g., none, fade, slide, convex, concave, zoom)
  backgroundTransition: 'fade',
  // Number of slides away from the current that are visible
  viewDistance: 3,
  // Number of slides away from the current that are visible on mobile
  // devices. It is advisable to set this to a lower number than
  // viewDistance in order to save resources.
  mobileViewDistance: 3,
  // Parallax background image (e.g., "'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg'")
  parallaxBackgroundImage: '',
  // Parallax background size in CSS syntax (e.g., "2100px 900px")
  parallaxBackgroundSize: '',
  // Number of pixels to move the parallax background per slide
  // - Calculated automatically unless specified
  // - Set to 0 to disable movement along an axis
  parallaxBackgroundHorizontal: null,
  parallaxBackgroundVertical: null,
  // The display mode that will be used to show slides
  display: 'block',

  // The "normal" size of the presentation, aspect ratio will be preserved
  // when the presentation is scaled to fit different resolutions. Can be
  // specified using percentage units.
  width: 1920,
  height: 1080,

  // Factor of the display size that should remain empty around the content
  margin: 0.1,

  // Bounds for smallest/largest possible scale to apply to content
  minScale: 0.2,
  maxScale: 1.5,

  // PDF Export Options
  // Put each fragment on a separate page
  pdfSeparateFragments: true,
  // For slides that do not fit on a page, max number of pages
  pdfMaxPagesPerSlide: 1,

  // Optional libraries used to extend on reveal.js
  dependencies: [
      { src: 'reveal.js/plugin/zoom-js/zoom.js', async: true },
      { src: 'reveal.js/plugin/notes/notes.js', async: true },
      { src: 'https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js'},
{ src: 'revealjs-plugins/reveal.js-copycode-1.0.0/assets/js/revealjs/plugin/copycode/copycode.js'}
  ],

  

});</script><script>var dom = {};
dom.slides = document.querySelector('.reveal .slides');

function getRemainingHeight(element, slideElement, height) {
  height = height || 0;
  if (element) {
    var newHeight, oldHeight = element.style.height;
    // Change the .stretch element height to 0 in order find the height of all
    // the other elements
    element.style.height = '0px';
    // In Overview mode, the parent (.slide) height is set of 700px.
    // Restore it temporarily to its natural height.
    slideElement.style.height = 'auto';
    newHeight = height - slideElement.offsetHeight;
    // Restore the old height, just in case
    element.style.height = oldHeight + 'px';
    // Clear the parent (.slide) height. .removeProperty works in IE9+
    slideElement.style.removeProperty('height');
    return newHeight;
  }
  return height;
}

function layoutSlideContents(width, height) {
  // Handle sizing of elements with the 'stretch' class
  toArray(dom.slides.querySelectorAll('section .stretch')).forEach(function (element) {
    // Determine how much vertical space we can use
    var limit = 5; // hard limit
    var parent = element.parentNode;
    while (parent.nodeName !== 'SECTION' && limit > 0) {
      parent = parent.parentNode;
      limit--;
    }
    if (limit === 0) {
      // unable to find parent, aborting!
      return;
    }
    var remainingHeight = getRemainingHeight(element, parent, height);
    // Consider the aspect ratio of media elements
    if (/(img|video)/gi.test(element.nodeName)) {
      var nw = element.naturalWidth || element.videoWidth, nh = element.naturalHeight || element.videoHeight;
      var es = Math.min(width / nw, remainingHeight / nh);
      element.style.width = (nw * es) + 'px';
      element.style.height = (nh * es) + 'px';
    } else {
      element.style.width = width + 'px';
      element.style.height = remainingHeight + 'px';
    }
  });
}

function toArray(o) {
  return Array.prototype.slice.call(o);
}

Reveal.addEventListener('slidechanged', function () {
  layoutSlideContents(1920, 1080)
});
Reveal.addEventListener('ready', function () {
  layoutSlideContents(1920, 1080)
});
Reveal.addEventListener('resize', function () {
  layoutSlideContents(1920, 1080)
});</script><link rel="stylesheet" href="reveal.js/lib/css/monokai.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>

<script>

/* highlightjs-line-numbers.js 2.6.0 | (C) 2018 Yauheni Pakala | MIT License | github.com/wcoder/highlightjs-line-numbers.js */
/* Edited by Hakim for reveal.js; removed async timeout */
!function(n,e){"use strict";function t(){var n=e.createElement("style");n.type="text/css",n.innerHTML=g(".{0}{border-collapse:collapse}.{0} td{padding:0}.{1}:before{content:attr({2})}",[v,L,b]),e.getElementsByTagName("head")[0].appendChild(n)}function r(t){"interactive"===e.readyState||"complete"===e.readyState?i(t):n.addEventListener("DOMContentLoaded",function(){i(t)})}function i(t){try{var r=e.querySelectorAll("code.hljs,code.nohighlight");for(var i in r)r.hasOwnProperty(i)&&l(r[i],t)}catch(o){n.console.error("LineNumbers error: ",o)}}function l(n,e){"object"==typeof n&&f(function(){n.innerHTML=s(n,e)})}function o(n,e){if("string"==typeof n){var t=document.createElement("code");return t.innerHTML=n,s(t,e)}}function s(n,e){e=e||{singleLine:!1};var t=e.singleLine?0:1;return c(n),a(n.innerHTML,t)}function a(n,e){var t=u(n);if(""===t[t.length-1].trim()&&t.pop(),t.length>e){for(var r="",i=0,l=t.length;i<l;i++)r+=g('<tr><td class="{0}"><div class="{1} {2}" {3}="{5}"></div></td><td class="{4}"><div class="{1}">{6}</div></td></tr>',[j,m,L,b,p,i+1,t[i].length>0?t[i]:" "]);return g('<table class="{0}">{1}</table>',[v,r])}return n}function c(n){var e=n.childNodes;for(var t in e)if(e.hasOwnProperty(t)){var r=e[t];h(r.textContent)>0&&(r.childNodes.length>0?c(r):d(r.parentNode))}}function d(n){var e=n.className;if(/hljs-/.test(e)){for(var t=u(n.innerHTML),r=0,i="";r<t.length;r++){var l=t[r].length>0?t[r]:" ";i+=g('<span class="{0}">{1}</span>\n',[e,l])}n.innerHTML=i.trim()}}function u(n){return 0===n.length?[]:n.split(y)}function h(n){return(n.trim().match(y)||[]).length}function f(e){e()}function g(n,e){return n.replace(/{(\d+)}/g,function(n,t){return e[t]?e[t]:n})}var v="hljs-ln",m="hljs-ln-line",p="hljs-ln-code",j="hljs-ln-numbers",L="hljs-ln-n",b="data-line-number",y=/\r\n|\r|\n/g;n.hljs?(n.hljs.initLineNumbersOnLoad=r,n.hljs.lineNumbersBlock=l,n.hljs.lineNumbersValue=o,t()):n.console.error("highlight.js not detected!")}(window,document);

/**
 * This reveal.js plugin is wrapper around the highlight.js
 * syntax highlighting library.
 */
(function( root, factory ) {
  if (typeof define === 'function' && define.amd) {
    root.RevealHighlight = factory();
  } else if( typeof exports === 'object' ) {
    module.exports = factory();
  } else {
    // Browser globals (root is window)
    root.RevealHighlight = factory();
  }
}( this, function() {

  // Function to perform a better "data-trim" on code snippets
  // Will slice an indentation amount on each line of the snippet (amount based on the line having the lowest indentation length)
  function betterTrim(snippetEl) {
    // Helper functions
    function trimLeft(val) {
      // Adapted from https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/Trim#Polyfill
      return val.replace(/^[\s\uFEFF\xA0]+/g, '');
    }
    function trimLineBreaks(input) {
      var lines = input.split('\n');

      // Trim line-breaks from the beginning
      for (var i = 0; i < lines.length; i++) {
        if (lines[i].trim() === '') {
          lines.splice(i--, 1);
        } else break;
      }

      // Trim line-breaks from the end
      for (var i = lines.length-1; i >= 0; i--) {
        if (lines[i].trim() === '') {
          lines.splice(i, 1);
        } else break;
      }

      return lines.join('\n');
    }

    // Main function for betterTrim()
    return (function(snippetEl) {
      var content = trimLineBreaks(snippetEl.innerHTML);
      var lines = content.split('\n');
      // Calculate the minimum amount to remove on each line start of the snippet (can be 0)
      var pad = lines.reduce(function(acc, line) {
        if (line.length > 0 && trimLeft(line).length > 0 && acc > line.length - trimLeft(line).length) {
          return line.length - trimLeft(line).length;
        }
        return acc;
      }, Number.POSITIVE_INFINITY);
      // Slice each line with this amount
      return lines.map(function(line, index) {
        return line.slice(pad);
      })
        .join('\n');
    })(snippetEl);
  }

  var RevealHighlight = {

    HIGHLIGHT_STEP_DELIMITER: '|',
    HIGHLIGHT_LINE_DELIMITER: ',',
    HIGHLIGHT_LINE_RANGE_DELIMITER: '-',

    init: function() {

      // Read the plugin config options and provide fallbacks
      var config = Reveal.getConfig().highlight || {};
      config.highlightOnLoad = typeof config.highlightOnLoad === 'boolean' ? config.highlightOnLoad : true;
      config.escapeHTML = typeof config.escapeHTML === 'boolean' ? config.escapeHTML : true;

      [].slice.call( document.querySelectorAll( '.reveal pre code' ) ).forEach( function( block ) {

        // Trim whitespace if the "data-trim" attribute is present
        if( block.hasAttribute( 'data-trim' ) && typeof block.innerHTML.trim === 'function' ) {
          block.innerHTML = betterTrim( block );
        }

        // Escape HTML tags unless the "data-noescape" attrbute is present
        if( config.escapeHTML && !block.hasAttribute( 'data-noescape' )) {
          block.innerHTML = block.innerHTML.replace( /</g,"&lt;").replace(/>/g, '&gt;' );
        }

        // Re-highlight when focus is lost (for contenteditable code)
        block.addEventListener( 'focusout', function( event ) {
          hljs.highlightBlock( event.currentTarget );
        }, false );

        if( config.highlightOnLoad ) {
          RevealHighlight.highlightBlock( block );
        }
      } );

    },

    /**
     * Highlights a code block. If the <code> node has the
     * 'data-line-numbers' attribute we also generate slide
     * numbers.
     *
     * If the block contains multiple line highlight steps,
     * we clone the block and create a fragment for each step.
     */
    highlightBlock: function( block ) {

      hljs.highlightBlock( block );

      // Don't generate line numbers for empty code blocks
      if( block.innerHTML.trim().length === 0 ) return;

      if( block.hasAttribute( 'data-line-numbers' ) ) {
        hljs.lineNumbersBlock( block, { singleLine: true } );

        // If there is at least one highlight step, generate
        // fragments
        var highlightSteps = RevealHighlight.deserializeHighlightSteps( block.getAttribute( 'data-line-numbers' ) );
        if( highlightSteps.length > 1 ) {

          // If the original code block has a fragment-index,
          // each clone should follow in an incremental sequence
          var fragmentIndex = parseInt( block.getAttribute( 'data-fragment-index' ), 10 );
          if( typeof fragmentIndex !== 'number' || isNaN( fragmentIndex ) ) {
            fragmentIndex = null;
          }

          // Generate fragments for all steps except the original block
          highlightSteps.slice(1).forEach( function( highlight ) {

            var fragmentBlock = block.cloneNode( true );
            fragmentBlock.setAttribute( 'data-line-numbers', RevealHighlight.serializeHighlightSteps( [ highlight ] ) );
            fragmentBlock.classList.add( 'fragment' );
            block.parentNode.appendChild( fragmentBlock );
            RevealHighlight.highlightLines( fragmentBlock );

            if( typeof fragmentIndex === 'number' ) {
              fragmentBlock.setAttribute( 'data-fragment-index', fragmentIndex );
              fragmentIndex += 1;
            }
            else {
              fragmentBlock.removeAttribute( 'data-fragment-index' );
            }

          } );

          block.removeAttribute( 'data-fragment-index' )
          block.setAttribute( 'data-line-numbers', RevealHighlight.serializeHighlightSteps( [ highlightSteps[0] ] ) );

        }

        RevealHighlight.highlightLines( block );

      }

    },

    /**
     * Visually emphasize specific lines within a code block.
     * This only works on blocks with line numbering turned on.
     *
     * @param {HTMLElement} block a <code> block
     * @param {String} [linesToHighlight] The lines that should be
     * highlighted in this format:
     * "1" 		= highlights line 1
     * "2,5"	= highlights lines 2 & 5
     * "2,5-7"	= highlights lines 2, 5, 6 & 7
     */
    highlightLines: function( block, linesToHighlight ) {

      var highlightSteps = RevealHighlight.deserializeHighlightSteps( linesToHighlight || block.getAttribute( 'data-line-numbers' ) );

      if( highlightSteps.length ) {

        highlightSteps[0].forEach( function( highlight ) {

          var elementsToHighlight = [];

          // Highlight a range
          if( typeof highlight.end === 'number' ) {
            elementsToHighlight = [].slice.call( block.querySelectorAll( 'table tr:nth-child(n+'+highlight.start+'):nth-child(-n+'+highlight.end+')' ) );
          }
          // Highlight a single line
          else if( typeof highlight.start === 'number' ) {
            elementsToHighlight = [].slice.call( block.querySelectorAll( 'table tr:nth-child('+highlight.start+')' ) );
          }

          if( elementsToHighlight.length ) {
            elementsToHighlight.forEach( function( lineElement ) {
              lineElement.classList.add( 'highlight-line' );
            } );

            block.classList.add( 'has-highlights' );
          }

        } );

      }

    },

    /**
     * Parses and formats a user-defined string of line
     * numbers to highlight.
     *
     * @example
     * RevealHighlight.deserializeHighlightSteps( '1,2|3,5-10' )
     * // [
     * //   [ { start: 1 }, { start: 2 } ],
     * //   [ { start: 3 }, { start: 5, end: 10 } ]
     * // ]
     */
    deserializeHighlightSteps: function( highlightSteps ) {

      // Remove whitespace
      highlightSteps = highlightSteps.replace( /\s/g, '' );

      // Divide up our line number groups
      highlightSteps = highlightSteps.split( RevealHighlight.HIGHLIGHT_STEP_DELIMITER );

      return highlightSteps.map( function( highlights ) {

        return highlights.split( RevealHighlight.HIGHLIGHT_LINE_DELIMITER ).map( function( highlight ) {

          // Parse valid line numbers
          if( /^[\d-]+$/.test( highlight ) ) {

            highlight = highlight.split( RevealHighlight.HIGHLIGHT_LINE_RANGE_DELIMITER );

            var lineStart = parseInt( highlight[0], 10 ),
              lineEnd = parseInt( highlight[1], 10 );

            if( isNaN( lineEnd ) ) {
              return {
                start: lineStart
              };
            }
            else {
              return {
                start: lineStart,
                end: lineEnd
              };
            }

          }
          // If no line numbers are provided, no code will be highlighted
          else {

            return {};

          }

        } );

      } );

    },

    /**
     * Serializes parsed line number data into a string so
     * that we can store it in the DOM.
     */
    serializeHighlightSteps: function( highlightSteps ) {

      return highlightSteps.map( function( highlights ) {

        return highlights.map( function( highlight ) {

          // Line range
          if( typeof highlight.end === 'number' ) {
            return highlight.start + RevealHighlight.HIGHLIGHT_LINE_RANGE_DELIMITER + highlight.end;
          }
          // Single line
          else if( typeof highlight.start === 'number' ) {
            return highlight.start;
          }
          // All lines
          else {
            return '';
          }

        } ).join( RevealHighlight.HIGHLIGHT_LINE_DELIMITER );

      } ).join( RevealHighlight.HIGHLIGHT_STEP_DELIMITER );

    }

  }

  Reveal.registerPlugin( 'highlight', RevealHighlight );

  return RevealHighlight;

}));
        
hljs.initHighlightingOnLoad();
</script></body></html>